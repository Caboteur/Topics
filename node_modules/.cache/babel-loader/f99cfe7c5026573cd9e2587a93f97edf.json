{"ast":null,"code":"'use strict';\n\nvar _possibleConstructorReturn = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/possibleConstructorReturn\");\n\nvar _getPrototypeOf = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/getPrototypeOf\");\n\nvar _assertThisInitialized = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/assertThisInitialized\");\n\nvar _inherits = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/inherits\");\n\nvar _wrapNativeSuper = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/wrapNativeSuper\");\n\nvar _regeneratorRuntime = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/asyncToGenerator\");\n\nvar _objectSpread = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/objectSpread2\");\n\nvar _toArray = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/toArray\");\n\nvar _classCallCheck = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"D:\\\\MegaSync\\\\proxy-server\\\\testing\\\\react-express-starter\\\\node_modules\\\\@babel\\\\runtime/helpers/createClass\");\n\nvar EventEmitter = require('events');\n\nvar urlLib = require('url');\n\nvar normalizeUrl = require('normalize-url');\n\nvar getStream = require('get-stream');\n\nvar CachePolicy = require('http-cache-semantics');\n\nvar Response = require('responselike');\n\nvar lowercaseKeys = require('lowercase-keys');\n\nvar cloneResponse = require('clone-response');\n\nvar Keyv = require('keyv');\n\nvar CacheableRequest =\n/*#__PURE__*/\nfunction () {\n  function CacheableRequest(request, cacheAdapter) {\n    _classCallCheck(this, CacheableRequest);\n\n    if (typeof request !== 'function') {\n      throw new TypeError('Parameter `request` must be a function');\n    }\n\n    this.cache = new Keyv({\n      uri: typeof cacheAdapter === 'string' && cacheAdapter,\n      store: typeof cacheAdapter !== 'string' && cacheAdapter,\n      namespace: 'cacheable-request'\n    });\n    return this.createCacheableRequest(request);\n  }\n\n  _createClass(CacheableRequest, [{\n    key: \"createCacheableRequest\",\n    value: function createCacheableRequest(request) {\n      var _this = this;\n\n      return function (opts, cb) {\n        var url;\n\n        if (typeof opts === 'string') {\n          url = normalizeUrlObject(urlLib.parse(opts));\n          opts = {};\n        } else if (opts instanceof urlLib.URL) {\n          url = normalizeUrlObject(urlLib.parse(opts.toString()));\n          opts = {};\n        } else {\n          var _split = (opts.path || '').split('?'),\n              _split2 = _toArray(_split),\n              pathname = _split2[0],\n              searchParts = _split2.slice(1);\n\n          var search = searchParts.length > 0 ? \"?\".concat(searchParts.join('?')) : '';\n          url = normalizeUrlObject(_objectSpread({}, opts, {\n            pathname: pathname,\n            search: search\n          }));\n        }\n\n        opts = _objectSpread({\n          headers: {},\n          method: 'GET',\n          cache: true,\n          strictTtl: false,\n          automaticFailover: false\n        }, opts, {}, urlObjectToRequestOptions(url));\n        opts.headers = lowercaseKeys(opts.headers);\n        var ee = new EventEmitter();\n        var normalizedUrlString = normalizeUrl(urlLib.format(url), {\n          stripWWW: false,\n          removeTrailingSlash: false,\n          stripAuthentication: false\n        });\n        var key = \"\".concat(opts.method, \":\").concat(normalizedUrlString);\n        var revalidate = false;\n        var madeRequest = false;\n\n        var makeRequest = function makeRequest(opts) {\n          madeRequest = true;\n          var requestErrored = false;\n          var requestErrorCallback;\n          var requestErrorPromise = new Promise(function (resolve) {\n            requestErrorCallback = function requestErrorCallback() {\n              if (!requestErrored) {\n                requestErrored = true;\n                resolve();\n              }\n            };\n          });\n\n          var handler = function handler(response) {\n            if (revalidate && !opts.forceRefresh) {\n              response.status = response.statusCode;\n              var revalidatedPolicy = CachePolicy.fromObject(revalidate.cachePolicy).revalidatedPolicy(opts, response);\n\n              if (!revalidatedPolicy.modified) {\n                var headers = revalidatedPolicy.policy.responseHeaders();\n                response = new Response(revalidate.statusCode, headers, revalidate.body, revalidate.url);\n                response.cachePolicy = revalidatedPolicy.policy;\n                response.fromCache = true;\n              }\n            }\n\n            if (!response.fromCache) {\n              response.cachePolicy = new CachePolicy(opts, response, opts);\n              response.fromCache = false;\n            }\n\n            var clonedResponse;\n\n            if (opts.cache && response.cachePolicy.storable()) {\n              clonedResponse = cloneResponse(response);\n\n              _asyncToGenerator(\n              /*#__PURE__*/\n              _regeneratorRuntime.mark(function _callee() {\n                var bodyPromise, body, value, ttl;\n                return _regeneratorRuntime.wrap(function _callee$(_context) {\n                  while (1) {\n                    switch (_context.prev = _context.next) {\n                      case 0:\n                        _context.prev = 0;\n                        bodyPromise = getStream.buffer(response);\n                        _context.next = 4;\n                        return Promise.race([requestErrorPromise, new Promise(function (resolve) {\n                          return response.once('end', resolve);\n                        })]);\n\n                      case 4:\n                        if (!requestErrored) {\n                          _context.next = 6;\n                          break;\n                        }\n\n                        return _context.abrupt(\"return\");\n\n                      case 6:\n                        _context.next = 8;\n                        return bodyPromise;\n\n                      case 8:\n                        body = _context.sent;\n                        value = {\n                          cachePolicy: response.cachePolicy.toObject(),\n                          url: response.url,\n                          statusCode: response.fromCache ? revalidate.statusCode : response.statusCode,\n                          body: body\n                        };\n                        ttl = opts.strictTtl ? response.cachePolicy.timeToLive() : undefined;\n\n                        if (opts.maxTtl) {\n                          ttl = ttl ? Math.min(ttl, opts.maxTtl) : opts.maxTtl;\n                        }\n\n                        _context.next = 14;\n                        return _this.cache.set(key, value, ttl);\n\n                      case 14:\n                        _context.next = 19;\n                        break;\n\n                      case 16:\n                        _context.prev = 16;\n                        _context.t0 = _context[\"catch\"](0);\n                        ee.emit('error', new CacheableRequest.CacheError(_context.t0));\n\n                      case 19:\n                      case \"end\":\n                        return _context.stop();\n                    }\n                  }\n                }, _callee, null, [[0, 16]]);\n              }))();\n            } else if (opts.cache && revalidate) {\n              _asyncToGenerator(\n              /*#__PURE__*/\n              _regeneratorRuntime.mark(function _callee2() {\n                return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                  while (1) {\n                    switch (_context2.prev = _context2.next) {\n                      case 0:\n                        _context2.prev = 0;\n                        _context2.next = 3;\n                        return _this.cache.delete(key);\n\n                      case 3:\n                        _context2.next = 8;\n                        break;\n\n                      case 5:\n                        _context2.prev = 5;\n                        _context2.t0 = _context2[\"catch\"](0);\n                        ee.emit('error', new CacheableRequest.CacheError(_context2.t0));\n\n                      case 8:\n                      case \"end\":\n                        return _context2.stop();\n                    }\n                  }\n                }, _callee2, null, [[0, 5]]);\n              }))();\n            }\n\n            ee.emit('response', clonedResponse || response);\n\n            if (typeof cb === 'function') {\n              cb(clonedResponse || response);\n            }\n          };\n\n          try {\n            var req = request(opts, handler);\n            req.once('error', requestErrorCallback);\n            req.once('abort', requestErrorCallback);\n            ee.emit('request', req);\n          } catch (error) {\n            ee.emit('error', new CacheableRequest.RequestError(error));\n          }\n        };\n\n        _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee4() {\n          var get, errorHandler;\n          return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n            while (1) {\n              switch (_context4.prev = _context4.next) {\n                case 0:\n                  get =\n                  /*#__PURE__*/\n                  function () {\n                    var _ref4 = _asyncToGenerator(\n                    /*#__PURE__*/\n                    _regeneratorRuntime.mark(function _callee3(opts) {\n                      var cacheEntry, policy, headers, response;\n                      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                        while (1) {\n                          switch (_context3.prev = _context3.next) {\n                            case 0:\n                              _context3.next = 2;\n                              return Promise.resolve();\n\n                            case 2:\n                              if (!opts.cache) {\n                                _context3.next = 8;\n                                break;\n                              }\n\n                              _context3.next = 5;\n                              return _this.cache.get(key);\n\n                            case 5:\n                              _context3.t0 = _context3.sent;\n                              _context3.next = 9;\n                              break;\n\n                            case 8:\n                              _context3.t0 = undefined;\n\n                            case 9:\n                              cacheEntry = _context3.t0;\n\n                              if (!(typeof cacheEntry === 'undefined')) {\n                                _context3.next = 12;\n                                break;\n                              }\n\n                              return _context3.abrupt(\"return\", makeRequest(opts));\n\n                            case 12:\n                              policy = CachePolicy.fromObject(cacheEntry.cachePolicy);\n\n                              if (policy.satisfiesWithoutRevalidation(opts) && !opts.forceRefresh) {\n                                headers = policy.responseHeaders();\n                                response = new Response(cacheEntry.statusCode, headers, cacheEntry.body, cacheEntry.url);\n                                response.cachePolicy = policy;\n                                response.fromCache = true;\n                                ee.emit('response', response);\n\n                                if (typeof cb === 'function') {\n                                  cb(response);\n                                }\n                              } else {\n                                revalidate = cacheEntry;\n                                opts.headers = policy.revalidationHeaders(opts);\n                                makeRequest(opts);\n                              }\n\n                            case 14:\n                            case \"end\":\n                              return _context3.stop();\n                          }\n                        }\n                      }, _callee3);\n                    }));\n\n                    return function get(_x) {\n                      return _ref4.apply(this, arguments);\n                    };\n                  }();\n\n                  errorHandler = function errorHandler(error) {\n                    return ee.emit('error', new CacheableRequest.CacheError(error));\n                  };\n\n                  _this.cache.once('error', errorHandler);\n\n                  ee.on('response', function () {\n                    return _this.cache.removeListener('error', errorHandler);\n                  });\n                  _context4.prev = 4;\n                  _context4.next = 7;\n                  return get(opts);\n\n                case 7:\n                  _context4.next = 13;\n                  break;\n\n                case 9:\n                  _context4.prev = 9;\n                  _context4.t0 = _context4[\"catch\"](4);\n\n                  if (opts.automaticFailover && !madeRequest) {\n                    makeRequest(opts);\n                  }\n\n                  ee.emit('error', new CacheableRequest.CacheError(_context4.t0));\n\n                case 13:\n                case \"end\":\n                  return _context4.stop();\n              }\n            }\n          }, _callee4, null, [[4, 9]]);\n        }))();\n\n        return ee;\n      };\n    }\n  }]);\n\n  return CacheableRequest;\n}();\n\nfunction urlObjectToRequestOptions(url) {\n  var options = _objectSpread({}, url);\n\n  options.path = \"\".concat(url.pathname || '/').concat(url.search || '');\n  delete options.pathname;\n  delete options.search;\n  return options;\n}\n\nfunction normalizeUrlObject(url) {\n  // If url was parsed by url.parse or new URL:\n  // - hostname will be set\n  // - host will be hostname[:port]\n  // - port will be set if it was explicit in the parsed string\n  // Otherwise, url was from request options:\n  // - hostname or host may be set\n  // - host shall not have port encoded\n  return {\n    protocol: url.protocol,\n    auth: url.auth,\n    hostname: url.hostname || url.host || 'localhost',\n    port: url.port,\n    pathname: url.pathname,\n    search: url.search\n  };\n}\n\nCacheableRequest.RequestError =\n/*#__PURE__*/\nfunction (_Error) {\n  _inherits(_class, _Error);\n\n  function _class(error) {\n    var _this2;\n\n    _classCallCheck(this, _class);\n\n    _this2 = _possibleConstructorReturn(this, _getPrototypeOf(_class).call(this, error.message));\n    _this2.name = 'RequestError';\n    Object.assign(_assertThisInitialized(_this2), error);\n    return _this2;\n  }\n\n  return _class;\n}(_wrapNativeSuper(Error));\n\nCacheableRequest.CacheError =\n/*#__PURE__*/\nfunction (_Error2) {\n  _inherits(_class2, _Error2);\n\n  function _class2(error) {\n    var _this3;\n\n    _classCallCheck(this, _class2);\n\n    _this3 = _possibleConstructorReturn(this, _getPrototypeOf(_class2).call(this, error.message));\n    _this3.name = 'CacheError';\n    Object.assign(_assertThisInitialized(_this3), error);\n    return _this3;\n  }\n\n  return _class2;\n}(_wrapNativeSuper(Error));\n\nmodule.exports = CacheableRequest;","map":{"version":3,"sources":["D:/MegaSync/proxy-server/testing/react-express-starter/node_modules/cacheable-request/src/index.js"],"names":["EventEmitter","require","urlLib","normalizeUrl","getStream","CachePolicy","Response","lowercaseKeys","cloneResponse","Keyv","CacheableRequest","request","cacheAdapter","TypeError","cache","uri","store","namespace","createCacheableRequest","opts","cb","url","normalizeUrlObject","parse","URL","toString","path","split","pathname","searchParts","search","length","join","headers","method","strictTtl","automaticFailover","urlObjectToRequestOptions","ee","normalizedUrlString","format","stripWWW","removeTrailingSlash","stripAuthentication","key","revalidate","madeRequest","makeRequest","requestErrored","requestErrorCallback","requestErrorPromise","Promise","resolve","handler","response","forceRefresh","status","statusCode","revalidatedPolicy","fromObject","cachePolicy","modified","policy","responseHeaders","body","fromCache","clonedResponse","storable","bodyPromise","buffer","race","once","value","toObject","ttl","timeToLive","undefined","maxTtl","Math","min","set","emit","CacheError","delete","req","error","RequestError","get","cacheEntry","satisfiesWithoutRevalidation","revalidationHeaders","errorHandler","on","removeListener","options","protocol","auth","hostname","host","port","message","name","Object","assign","Error","module","exports"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,YAAY,GAAGC,OAAO,CAAC,QAAD,CAA5B;;AACA,IAAMC,MAAM,GAAGD,OAAO,CAAC,KAAD,CAAtB;;AACA,IAAME,YAAY,GAAGF,OAAO,CAAC,eAAD,CAA5B;;AACA,IAAMG,SAAS,GAAGH,OAAO,CAAC,YAAD,CAAzB;;AACA,IAAMI,WAAW,GAAGJ,OAAO,CAAC,sBAAD,CAA3B;;AACA,IAAMK,QAAQ,GAAGL,OAAO,CAAC,cAAD,CAAxB;;AACA,IAAMM,aAAa,GAAGN,OAAO,CAAC,gBAAD,CAA7B;;AACA,IAAMO,aAAa,GAAGP,OAAO,CAAC,gBAAD,CAA7B;;AACA,IAAMQ,IAAI,GAAGR,OAAO,CAAC,MAAD,CAApB;;IAEMS,gB;;;AACL,4BAAYC,OAAZ,EAAqBC,YAArB,EAAmC;AAAA;;AAClC,QAAI,OAAOD,OAAP,KAAmB,UAAvB,EAAmC;AAClC,YAAM,IAAIE,SAAJ,CAAc,wCAAd,CAAN;AACA;;AAED,SAAKC,KAAL,GAAa,IAAIL,IAAJ,CAAS;AACrBM,MAAAA,GAAG,EAAE,OAAOH,YAAP,KAAwB,QAAxB,IAAoCA,YADpB;AAErBI,MAAAA,KAAK,EAAE,OAAOJ,YAAP,KAAwB,QAAxB,IAAoCA,YAFtB;AAGrBK,MAAAA,SAAS,EAAE;AAHU,KAAT,CAAb;AAMA,WAAO,KAAKC,sBAAL,CAA4BP,OAA5B,CAAP;AACA;;;;2CAEsBA,O,EAAS;AAAA;;AAC/B,aAAO,UAACQ,IAAD,EAAOC,EAAP,EAAc;AACpB,YAAIC,GAAJ;;AACA,YAAI,OAAOF,IAAP,KAAgB,QAApB,EAA8B;AAC7BE,UAAAA,GAAG,GAAGC,kBAAkB,CAACpB,MAAM,CAACqB,KAAP,CAAaJ,IAAb,CAAD,CAAxB;AACAA,UAAAA,IAAI,GAAG,EAAP;AACA,SAHD,MAGO,IAAIA,IAAI,YAAYjB,MAAM,CAACsB,GAA3B,EAAgC;AACtCH,UAAAA,GAAG,GAAGC,kBAAkB,CAACpB,MAAM,CAACqB,KAAP,CAAaJ,IAAI,CAACM,QAAL,EAAb,CAAD,CAAxB;AACAN,UAAAA,IAAI,GAAG,EAAP;AACA,SAHM,MAGA;AAAA,uBAC6B,CAACA,IAAI,CAACO,IAAL,IAAa,EAAd,EAAkBC,KAAlB,CAAwB,GAAxB,CAD7B;AAAA;AAAA,cACCC,QADD;AAAA,cACcC,WADd;;AAEN,cAAMC,MAAM,GAAGD,WAAW,CAACE,MAAZ,GAAqB,CAArB,cACVF,WAAW,CAACG,IAAZ,CAAiB,GAAjB,CADU,IAEd,EAFD;AAGAX,UAAAA,GAAG,GAAGC,kBAAkB,mBAAMH,IAAN;AAAYS,YAAAA,QAAQ,EAARA,QAAZ;AAAsBE,YAAAA,MAAM,EAANA;AAAtB,aAAxB;AACA;;AAEDX,QAAAA,IAAI;AACHc,UAAAA,OAAO,EAAE,EADN;AAEHC,UAAAA,MAAM,EAAE,KAFL;AAGHpB,UAAAA,KAAK,EAAE,IAHJ;AAIHqB,UAAAA,SAAS,EAAE,KAJR;AAKHC,UAAAA,iBAAiB,EAAE;AALhB,WAMAjB,IANA,MAOAkB,yBAAyB,CAAChB,GAAD,CAPzB,CAAJ;AASAF,QAAAA,IAAI,CAACc,OAAL,GAAe1B,aAAa,CAACY,IAAI,CAACc,OAAN,CAA5B;AAEA,YAAMK,EAAE,GAAG,IAAItC,YAAJ,EAAX;AACA,YAAMuC,mBAAmB,GAAGpC,YAAY,CACvCD,MAAM,CAACsC,MAAP,CAAcnB,GAAd,CADuC,EAEvC;AACCoB,UAAAA,QAAQ,EAAE,KADX;AAECC,UAAAA,mBAAmB,EAAE,KAFtB;AAGCC,UAAAA,mBAAmB,EAAE;AAHtB,SAFuC,CAAxC;AAQA,YAAMC,GAAG,aAAMzB,IAAI,CAACe,MAAX,cAAqBK,mBAArB,CAAT;AACA,YAAIM,UAAU,GAAG,KAAjB;AACA,YAAIC,WAAW,GAAG,KAAlB;;AAEA,YAAMC,WAAW,GAAG,SAAdA,WAAc,CAAA5B,IAAI,EAAI;AAC3B2B,UAAAA,WAAW,GAAG,IAAd;AACA,cAAIE,cAAc,GAAG,KAArB;AACA,cAAIC,oBAAJ;AAEA,cAAMC,mBAAmB,GAAG,IAAIC,OAAJ,CAAY,UAAAC,OAAO,EAAI;AAClDH,YAAAA,oBAAoB,GAAG,gCAAM;AAC5B,kBAAI,CAACD,cAAL,EAAqB;AACpBA,gBAAAA,cAAc,GAAG,IAAjB;AACAI,gBAAAA,OAAO;AACP;AACD,aALD;AAMA,WAP2B,CAA5B;;AASA,cAAMC,OAAO,GAAG,SAAVA,OAAU,CAAAC,QAAQ,EAAI;AAC3B,gBAAIT,UAAU,IAAI,CAAC1B,IAAI,CAACoC,YAAxB,EAAsC;AACrCD,cAAAA,QAAQ,CAACE,MAAT,GAAkBF,QAAQ,CAACG,UAA3B;AACA,kBAAMC,iBAAiB,GAAGrD,WAAW,CAACsD,UAAZ,CAAuBd,UAAU,CAACe,WAAlC,EAA+CF,iBAA/C,CAAiEvC,IAAjE,EAAuEmC,QAAvE,CAA1B;;AACA,kBAAI,CAACI,iBAAiB,CAACG,QAAvB,EAAiC;AAChC,oBAAM5B,OAAO,GAAGyB,iBAAiB,CAACI,MAAlB,CAAyBC,eAAzB,EAAhB;AACAT,gBAAAA,QAAQ,GAAG,IAAIhD,QAAJ,CAAauC,UAAU,CAACY,UAAxB,EAAoCxB,OAApC,EAA6CY,UAAU,CAACmB,IAAxD,EAA8DnB,UAAU,CAACxB,GAAzE,CAAX;AACAiC,gBAAAA,QAAQ,CAACM,WAAT,GAAuBF,iBAAiB,CAACI,MAAzC;AACAR,gBAAAA,QAAQ,CAACW,SAAT,GAAqB,IAArB;AACA;AACD;;AAED,gBAAI,CAACX,QAAQ,CAACW,SAAd,EAAyB;AACxBX,cAAAA,QAAQ,CAACM,WAAT,GAAuB,IAAIvD,WAAJ,CAAgBc,IAAhB,EAAsBmC,QAAtB,EAAgCnC,IAAhC,CAAvB;AACAmC,cAAAA,QAAQ,CAACW,SAAT,GAAqB,KAArB;AACA;;AAED,gBAAIC,cAAJ;;AACA,gBAAI/C,IAAI,CAACL,KAAL,IAAcwC,QAAQ,CAACM,WAAT,CAAqBO,QAArB,EAAlB,EAAmD;AAClDD,cAAAA,cAAc,GAAG1D,aAAa,CAAC8C,QAAD,CAA9B;;AAEA;AAAA;AAAA,uCAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEOc,wBAAAA,WAFP,GAEqBhE,SAAS,CAACiE,MAAV,CAAiBf,QAAjB,CAFrB;AAAA;AAAA,+BAIOH,OAAO,CAACmB,IAAR,CAAa,CAClBpB,mBADkB,EAElB,IAAIC,OAAJ,CAAY,UAAAC,OAAO;AAAA,iCAAIE,QAAQ,CAACiB,IAAT,CAAc,KAAd,EAAqBnB,OAArB,CAAJ;AAAA,yBAAnB,CAFkB,CAAb,CAJP;;AAAA;AAAA,6BASKJ,cATL;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,+BAaoBoB,WAbpB;;AAAA;AAaOJ,wBAAAA,IAbP;AAeOQ,wBAAAA,KAfP,GAee;AACbZ,0BAAAA,WAAW,EAAEN,QAAQ,CAACM,WAAT,CAAqBa,QAArB,EADA;AAEbpD,0BAAAA,GAAG,EAAEiC,QAAQ,CAACjC,GAFD;AAGboC,0BAAAA,UAAU,EAAEH,QAAQ,CAACW,SAAT,GAAqBpB,UAAU,CAACY,UAAhC,GAA6CH,QAAQ,CAACG,UAHrD;AAIbO,0BAAAA,IAAI,EAAJA;AAJa,yBAff;AAsBKU,wBAAAA,GAtBL,GAsBWvD,IAAI,CAACgB,SAAL,GAAiBmB,QAAQ,CAACM,WAAT,CAAqBe,UAArB,EAAjB,GAAqDC,SAtBhE;;AAuBC,4BAAIzD,IAAI,CAAC0D,MAAT,EAAiB;AAChBH,0BAAAA,GAAG,GAAGA,GAAG,GAAGI,IAAI,CAACC,GAAL,CAASL,GAAT,EAAcvD,IAAI,CAAC0D,MAAnB,CAAH,GAAgC1D,IAAI,CAAC0D,MAA9C;AACA;;AAzBF;AAAA,+BA2BO,KAAI,CAAC/D,KAAL,CAAWkE,GAAX,CAAepC,GAAf,EAAoB4B,KAApB,EAA2BE,GAA3B,CA3BP;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AA6BCpC,wBAAAA,EAAE,CAAC2C,IAAH,CAAQ,OAAR,EAAiB,IAAIvE,gBAAgB,CAACwE,UAArB,aAAjB;;AA7BD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAD;AAgCA,aAnCD,MAmCO,IAAI/D,IAAI,CAACL,KAAL,IAAc+B,UAAlB,EAA8B;AACpC;AAAA;AAAA,uCAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAEO,KAAI,CAAC/B,KAAL,CAAWqE,MAAX,CAAkBvC,GAAlB,CAFP;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAICN,wBAAAA,EAAE,CAAC2C,IAAH,CAAQ,OAAR,EAAiB,IAAIvE,gBAAgB,CAACwE,UAArB,cAAjB;;AAJD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAAD;AAOA;;AAED5C,YAAAA,EAAE,CAAC2C,IAAH,CAAQ,UAAR,EAAoBf,cAAc,IAAIZ,QAAtC;;AACA,gBAAI,OAAOlC,EAAP,KAAc,UAAlB,EAA8B;AAC7BA,cAAAA,EAAE,CAAC8C,cAAc,IAAIZ,QAAnB,CAAF;AACA;AACD,WAnED;;AAqEA,cAAI;AACH,gBAAM8B,GAAG,GAAGzE,OAAO,CAACQ,IAAD,EAAOkC,OAAP,CAAnB;AACA+B,YAAAA,GAAG,CAACb,IAAJ,CAAS,OAAT,EAAkBtB,oBAAlB;AACAmC,YAAAA,GAAG,CAACb,IAAJ,CAAS,OAAT,EAAkBtB,oBAAlB;AACAX,YAAAA,EAAE,CAAC2C,IAAH,CAAQ,SAAR,EAAmBG,GAAnB;AACA,WALD,CAKE,OAAOC,KAAP,EAAc;AACf/C,YAAAA,EAAE,CAAC2C,IAAH,CAAQ,OAAR,EAAiB,IAAIvE,gBAAgB,CAAC4E,YAArB,CAAkCD,KAAlC,CAAjB;AACA;AACD,SA3FD;;AA6FA;AAAA;AAAA,iCAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AACME,kBAAAA,GADN;AAAA;AAAA;AAAA;AAAA;AAAA,6CACY,kBAAMpE,IAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qCACLgC,OAAO,CAACC,OAAR,EADK;;AAAA;AAAA,mCAGQjC,IAAI,CAACL,KAHb;AAAA;AAAA;AAAA;;AAAA;AAAA,qCAG2B,KAAI,CAACA,KAAL,CAAWyE,GAAX,CAAe3C,GAAf,CAH3B;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA,6CAGiDgC,SAHjD;;AAAA;AAGLY,8BAAAA,UAHK;;AAAA,oCAIP,OAAOA,UAAP,KAAsB,WAJf;AAAA;AAAA;AAAA;;AAAA,gEAKHzC,WAAW,CAAC5B,IAAD,CALR;;AAAA;AAQL2C,8BAAAA,MARK,GAQIzD,WAAW,CAACsD,UAAZ,CAAuB6B,UAAU,CAAC5B,WAAlC,CARJ;;AASX,kCAAIE,MAAM,CAAC2B,4BAAP,CAAoCtE,IAApC,KAA6C,CAACA,IAAI,CAACoC,YAAvD,EAAqE;AAC9DtB,gCAAAA,OAD8D,GACpD6B,MAAM,CAACC,eAAP,EADoD;AAE9DT,gCAAAA,QAF8D,GAEnD,IAAIhD,QAAJ,CAAakF,UAAU,CAAC/B,UAAxB,EAAoCxB,OAApC,EAA6CuD,UAAU,CAACxB,IAAxD,EAA8DwB,UAAU,CAACnE,GAAzE,CAFmD;AAGpEiC,gCAAAA,QAAQ,CAACM,WAAT,GAAuBE,MAAvB;AACAR,gCAAAA,QAAQ,CAACW,SAAT,GAAqB,IAArB;AAEA3B,gCAAAA,EAAE,CAAC2C,IAAH,CAAQ,UAAR,EAAoB3B,QAApB;;AACA,oCAAI,OAAOlC,EAAP,KAAc,UAAlB,EAA8B;AAC7BA,kCAAAA,EAAE,CAACkC,QAAD,CAAF;AACA;AACD,+BAVD,MAUO;AACNT,gCAAAA,UAAU,GAAG2C,UAAb;AACArE,gCAAAA,IAAI,CAACc,OAAL,GAAe6B,MAAM,CAAC4B,mBAAP,CAA2BvE,IAA3B,CAAf;AACA4B,gCAAAA,WAAW,CAAC5B,IAAD,CAAX;AACA;;AAvBU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBADZ;;AAAA,oCACMoE,GADN;AAAA;AAAA;AAAA;;AA2BMI,kBAAAA,YA3BN,GA2BqB,SAAfA,YAAe,CAAAN,KAAK;AAAA,2BAAI/C,EAAE,CAAC2C,IAAH,CAAQ,OAAR,EAAiB,IAAIvE,gBAAgB,CAACwE,UAArB,CAAgCG,KAAhC,CAAjB,CAAJ;AAAA,mBA3B1B;;AA4BA,kBAAA,KAAI,CAACvE,KAAL,CAAWyD,IAAX,CAAgB,OAAhB,EAAyBoB,YAAzB;;AACArD,kBAAAA,EAAE,CAACsD,EAAH,CAAM,UAAN,EAAkB;AAAA,2BAAM,KAAI,CAAC9E,KAAL,CAAW+E,cAAX,CAA0B,OAA1B,EAAmCF,YAAnC,CAAN;AAAA,mBAAlB;AA7BA;AAAA;AAAA,yBAgCOJ,GAAG,CAACpE,IAAD,CAhCV;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAkCC,sBAAIA,IAAI,CAACiB,iBAAL,IAA0B,CAACU,WAA/B,EAA4C;AAC3CC,oBAAAA,WAAW,CAAC5B,IAAD,CAAX;AACA;;AAEDmB,kBAAAA,EAAE,CAAC2C,IAAH,CAAQ,OAAR,EAAiB,IAAIvE,gBAAgB,CAACwE,UAArB,cAAjB;;AAtCD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAD;;AA0CA,eAAO5C,EAAP;AACA,OAhLD;AAiLA;;;;;;AAGF,SAASD,yBAAT,CAAmChB,GAAnC,EAAwC;AACvC,MAAMyE,OAAO,qBAAQzE,GAAR,CAAb;;AACAyE,EAAAA,OAAO,CAACpE,IAAR,aAAkBL,GAAG,CAACO,QAAJ,IAAgB,GAAlC,SAAwCP,GAAG,CAACS,MAAJ,IAAc,EAAtD;AACA,SAAOgE,OAAO,CAAClE,QAAf;AACA,SAAOkE,OAAO,CAAChE,MAAf;AACA,SAAOgE,OAAP;AACA;;AAED,SAASxE,kBAAT,CAA4BD,GAA5B,EAAiC;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAO;AACN0E,IAAAA,QAAQ,EAAE1E,GAAG,CAAC0E,QADR;AAENC,IAAAA,IAAI,EAAE3E,GAAG,CAAC2E,IAFJ;AAGNC,IAAAA,QAAQ,EAAE5E,GAAG,CAAC4E,QAAJ,IAAgB5E,GAAG,CAAC6E,IAApB,IAA4B,WAHhC;AAINC,IAAAA,IAAI,EAAE9E,GAAG,CAAC8E,IAJJ;AAKNvE,IAAAA,QAAQ,EAAEP,GAAG,CAACO,QALR;AAMNE,IAAAA,MAAM,EAAET,GAAG,CAACS;AANN,GAAP;AAQA;;AAEDpB,gBAAgB,CAAC4E,YAAjB;AAAA;AAAA;AAAA;;AACC,kBAAYD,KAAZ,EAAmB;AAAA;;AAAA;;AAClB,iFAAMA,KAAK,CAACe,OAAZ;AACA,WAAKC,IAAL,GAAY,cAAZ;AACAC,IAAAA,MAAM,CAACC,MAAP,iCAAoBlB,KAApB;AAHkB;AAIlB;;AALF;AAAA,mBAA8CmB,KAA9C;;AAQA9F,gBAAgB,CAACwE,UAAjB;AAAA;AAAA;AAAA;;AACC,mBAAYG,KAAZ,EAAmB;AAAA;;AAAA;;AAClB,kFAAMA,KAAK,CAACe,OAAZ;AACA,WAAKC,IAAL,GAAY,YAAZ;AACAC,IAAAA,MAAM,CAACC,MAAP,iCAAoBlB,KAApB;AAHkB;AAIlB;;AALF;AAAA,mBAA4CmB,KAA5C;;AAQAC,MAAM,CAACC,OAAP,GAAiBhG,gBAAjB","sourcesContent":["'use strict';\n\nconst EventEmitter = require('events');\nconst urlLib = require('url');\nconst normalizeUrl = require('normalize-url');\nconst getStream = require('get-stream');\nconst CachePolicy = require('http-cache-semantics');\nconst Response = require('responselike');\nconst lowercaseKeys = require('lowercase-keys');\nconst cloneResponse = require('clone-response');\nconst Keyv = require('keyv');\n\nclass CacheableRequest {\n\tconstructor(request, cacheAdapter) {\n\t\tif (typeof request !== 'function') {\n\t\t\tthrow new TypeError('Parameter `request` must be a function');\n\t\t}\n\n\t\tthis.cache = new Keyv({\n\t\t\turi: typeof cacheAdapter === 'string' && cacheAdapter,\n\t\t\tstore: typeof cacheAdapter !== 'string' && cacheAdapter,\n\t\t\tnamespace: 'cacheable-request'\n\t\t});\n\n\t\treturn this.createCacheableRequest(request);\n\t}\n\n\tcreateCacheableRequest(request) {\n\t\treturn (opts, cb) => {\n\t\t\tlet url;\n\t\t\tif (typeof opts === 'string') {\n\t\t\t\turl = normalizeUrlObject(urlLib.parse(opts));\n\t\t\t\topts = {};\n\t\t\t} else if (opts instanceof urlLib.URL) {\n\t\t\t\turl = normalizeUrlObject(urlLib.parse(opts.toString()));\n\t\t\t\topts = {};\n\t\t\t} else {\n\t\t\t\tconst [pathname, ...searchParts] = (opts.path || '').split('?');\n\t\t\t\tconst search = searchParts.length > 0 ?\n\t\t\t\t\t`?${searchParts.join('?')}` :\n\t\t\t\t\t'';\n\t\t\t\turl = normalizeUrlObject({ ...opts, pathname, search });\n\t\t\t}\n\n\t\t\topts = {\n\t\t\t\theaders: {},\n\t\t\t\tmethod: 'GET',\n\t\t\t\tcache: true,\n\t\t\t\tstrictTtl: false,\n\t\t\t\tautomaticFailover: false,\n\t\t\t\t...opts,\n\t\t\t\t...urlObjectToRequestOptions(url)\n\t\t\t};\n\t\t\topts.headers = lowercaseKeys(opts.headers);\n\n\t\t\tconst ee = new EventEmitter();\n\t\t\tconst normalizedUrlString = normalizeUrl(\n\t\t\t\turlLib.format(url),\n\t\t\t\t{\n\t\t\t\t\tstripWWW: false,\n\t\t\t\t\tremoveTrailingSlash: false,\n\t\t\t\t\tstripAuthentication: false\n\t\t\t\t}\n\t\t\t);\n\t\t\tconst key = `${opts.method}:${normalizedUrlString}`;\n\t\t\tlet revalidate = false;\n\t\t\tlet madeRequest = false;\n\n\t\t\tconst makeRequest = opts => {\n\t\t\t\tmadeRequest = true;\n\t\t\t\tlet requestErrored = false;\n\t\t\t\tlet requestErrorCallback;\n\n\t\t\t\tconst requestErrorPromise = new Promise(resolve => {\n\t\t\t\t\trequestErrorCallback = () => {\n\t\t\t\t\t\tif (!requestErrored) {\n\t\t\t\t\t\t\trequestErrored = true;\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t});\n\n\t\t\t\tconst handler = response => {\n\t\t\t\t\tif (revalidate && !opts.forceRefresh) {\n\t\t\t\t\t\tresponse.status = response.statusCode;\n\t\t\t\t\t\tconst revalidatedPolicy = CachePolicy.fromObject(revalidate.cachePolicy).revalidatedPolicy(opts, response);\n\t\t\t\t\t\tif (!revalidatedPolicy.modified) {\n\t\t\t\t\t\t\tconst headers = revalidatedPolicy.policy.responseHeaders();\n\t\t\t\t\t\t\tresponse = new Response(revalidate.statusCode, headers, revalidate.body, revalidate.url);\n\t\t\t\t\t\t\tresponse.cachePolicy = revalidatedPolicy.policy;\n\t\t\t\t\t\t\tresponse.fromCache = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!response.fromCache) {\n\t\t\t\t\t\tresponse.cachePolicy = new CachePolicy(opts, response, opts);\n\t\t\t\t\t\tresponse.fromCache = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet clonedResponse;\n\t\t\t\t\tif (opts.cache && response.cachePolicy.storable()) {\n\t\t\t\t\t\tclonedResponse = cloneResponse(response);\n\n\t\t\t\t\t\t(async () => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tconst bodyPromise = getStream.buffer(response);\n\n\t\t\t\t\t\t\t\tawait Promise.race([\n\t\t\t\t\t\t\t\t\trequestErrorPromise,\n\t\t\t\t\t\t\t\t\tnew Promise(resolve => response.once('end', resolve))\n\t\t\t\t\t\t\t\t]);\n\n\t\t\t\t\t\t\t\tif (requestErrored) {\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tconst body = await bodyPromise;\n\n\t\t\t\t\t\t\t\tconst value = {\n\t\t\t\t\t\t\t\t\tcachePolicy: response.cachePolicy.toObject(),\n\t\t\t\t\t\t\t\t\turl: response.url,\n\t\t\t\t\t\t\t\t\tstatusCode: response.fromCache ? revalidate.statusCode : response.statusCode,\n\t\t\t\t\t\t\t\t\tbody\n\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\tlet ttl = opts.strictTtl ? response.cachePolicy.timeToLive() : undefined;\n\t\t\t\t\t\t\t\tif (opts.maxTtl) {\n\t\t\t\t\t\t\t\t\tttl = ttl ? Math.min(ttl, opts.maxTtl) : opts.maxTtl;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tawait this.cache.set(key, value, ttl);\n\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\tee.emit('error', new CacheableRequest.CacheError(error));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t} else if (opts.cache && revalidate) {\n\t\t\t\t\t\t(async () => {\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tawait this.cache.delete(key);\n\t\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\t\tee.emit('error', new CacheableRequest.CacheError(error));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})();\n\t\t\t\t\t}\n\n\t\t\t\t\tee.emit('response', clonedResponse || response);\n\t\t\t\t\tif (typeof cb === 'function') {\n\t\t\t\t\t\tcb(clonedResponse || response);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\tconst req = request(opts, handler);\n\t\t\t\t\treq.once('error', requestErrorCallback);\n\t\t\t\t\treq.once('abort', requestErrorCallback);\n\t\t\t\t\tee.emit('request', req);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tee.emit('error', new CacheableRequest.RequestError(error));\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t(async () => {\n\t\t\t\tconst get = async opts => {\n\t\t\t\t\tawait Promise.resolve();\n\n\t\t\t\t\tconst cacheEntry = opts.cache ? await this.cache.get(key) : undefined;\n\t\t\t\t\tif (typeof cacheEntry === 'undefined') {\n\t\t\t\t\t\treturn makeRequest(opts);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst policy = CachePolicy.fromObject(cacheEntry.cachePolicy);\n\t\t\t\t\tif (policy.satisfiesWithoutRevalidation(opts) && !opts.forceRefresh) {\n\t\t\t\t\t\tconst headers = policy.responseHeaders();\n\t\t\t\t\t\tconst response = new Response(cacheEntry.statusCode, headers, cacheEntry.body, cacheEntry.url);\n\t\t\t\t\t\tresponse.cachePolicy = policy;\n\t\t\t\t\t\tresponse.fromCache = true;\n\n\t\t\t\t\t\tee.emit('response', response);\n\t\t\t\t\t\tif (typeof cb === 'function') {\n\t\t\t\t\t\t\tcb(response);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\trevalidate = cacheEntry;\n\t\t\t\t\t\topts.headers = policy.revalidationHeaders(opts);\n\t\t\t\t\t\tmakeRequest(opts);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst errorHandler = error => ee.emit('error', new CacheableRequest.CacheError(error));\n\t\t\t\tthis.cache.once('error', errorHandler);\n\t\t\t\tee.on('response', () => this.cache.removeListener('error', errorHandler));\n\n\t\t\t\ttry {\n\t\t\t\t\tawait get(opts);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tif (opts.automaticFailover && !madeRequest) {\n\t\t\t\t\t\tmakeRequest(opts);\n\t\t\t\t\t}\n\n\t\t\t\t\tee.emit('error', new CacheableRequest.CacheError(error));\n\t\t\t\t}\n\t\t\t})();\n\n\t\t\treturn ee;\n\t\t};\n\t}\n}\n\nfunction urlObjectToRequestOptions(url) {\n\tconst options = { ...url };\n\toptions.path = `${url.pathname || '/'}${url.search || ''}`;\n\tdelete options.pathname;\n\tdelete options.search;\n\treturn options;\n}\n\nfunction normalizeUrlObject(url) {\n\t// If url was parsed by url.parse or new URL:\n\t// - hostname will be set\n\t// - host will be hostname[:port]\n\t// - port will be set if it was explicit in the parsed string\n\t// Otherwise, url was from request options:\n\t// - hostname or host may be set\n\t// - host shall not have port encoded\n\treturn {\n\t\tprotocol: url.protocol,\n\t\tauth: url.auth,\n\t\thostname: url.hostname || url.host || 'localhost',\n\t\tport: url.port,\n\t\tpathname: url.pathname,\n\t\tsearch: url.search\n\t};\n}\n\nCacheableRequest.RequestError = class extends Error {\n\tconstructor(error) {\n\t\tsuper(error.message);\n\t\tthis.name = 'RequestError';\n\t\tObject.assign(this, error);\n\t}\n};\n\nCacheableRequest.CacheError = class extends Error {\n\tconstructor(error) {\n\t\tsuper(error.message);\n\t\tthis.name = 'CacheError';\n\t\tObject.assign(this, error);\n\t}\n};\n\nmodule.exports = CacheableRequest;\n"]},"metadata":{},"sourceType":"script"}